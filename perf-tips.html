<!doctype html>
<html class="no-js" lang="en" data-content_root="./">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="genindex.html" /><link rel="search" title="Search" href="search.html" /><link rel="next" title="API Docs" href="api.html" /><link rel="prev" title="Inspecting Types" href="inspect.html" />

    <!-- Generated with Sphinx 8.2.3 and Furo 2024.08.06 -->
        <title>Performance Tips</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=b86133f3" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo-extensions.css?v=302659d7" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css?v=6b2c8899" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  --color-brand-primary: black;
  --color-brand-content: #024bb0;
  --color-foreground-muted: #808080;
  --color-highlight-on-target: inherit;
  --color-highlighted-background: #ffffcc;
  --color-sidebar-link-text: black;
  --color-sidebar-link-text--top-level: black;
  --color-link: #024bb0;
  --color-link--hover: #024bb0;
  --color-link-underline: transparent;
  --color-link-underline--hover: #024bb0;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: #ffffff;
  --color-brand-content: #5192d2;
  --color-highlight-on-target: inherit;
  --color-highlighted-background: #333300;
  --color-sidebar-link-text: #ffffffcc;
  --color-sidebar-link-text--top-level: #ffffffcc;
  --color-link: #5192d2;
  --color-link--hover: #5192d2;
  --color-link-underline: transparent;
  --color-link-underline--hover: #5192d2;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: #ffffff;
  --color-brand-content: #5192d2;
  --color-highlight-on-target: inherit;
  --color-highlighted-background: #333300;
  --color-sidebar-link-text: #ffffffcc;
  --color-sidebar-link-text--top-level: #ffffffcc;
  --color-link: #5192d2;
  --color-link--hover: #5192d2;
  --color-link-underline: transparent;
  --color-link-underline--hover: #5192d2;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="index.html"><div class="brand">msgspec</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo only-light" src="_static/msgspec-logo-light.svg" alt="Light Logo"/>
    <img class="sidebar-logo only-dark" src="_static/msgspec-logo-dark.svg" alt="Dark Logo"/>
  </div>
  
  
</a><form class="sidebar-search-container" method="get" action="search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="why.html">Why msgspec?</a></li>
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="benchmarks.html">Benchmarks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="supported-types.html">Supported Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="structs.html">Structs</a></li>
<li class="toctree-l1"><a class="reference internal" href="constraints.html">Constraints</a></li>
<li class="toctree-l1"><a class="reference internal" href="converters.html">Converters</a></li>
<li class="toctree-l1"><a class="reference internal" href="jsonschema.html">JSON Schema</a></li>
<li class="toctree-l1"><a class="reference internal" href="schema-evolution.html">Schema Evolution</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Advanced</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="extending.html">Extending</a></li>
<li class="toctree-l1"><a class="reference internal" href="inspect.html">Inspecting Types</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Performance Tips</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="api.html">API Docs</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="examples/index.html">Examples</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Examples</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="examples/geojson.html">GeoJSON</a></li>
<li class="toctree-l2"><a class="reference internal" href="examples/asyncio-kv.html">Asyncio TCP Key-Value Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="examples/conda-repodata.html">Conda Repodata</a></li>
<li class="toctree-l2"><a class="reference internal" href="examples/pyproject-toml.html">Parsing <code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="examples/edgedb.html">Usage with EdgeDB</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="_sources/perf-tips.rst.txt" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div>
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="performance-tips">
<h1>Performance Tips<a class="headerlink" href="#performance-tips" title="Link to this heading">¶</a></h1>
<p>Here we present a few tips and tricks for squeezing maximum performance out of
<code class="docutils literal notranslate"><span class="pre">msgspec</span></code>. They’re presented in order from “sane, definitely a good idea” to
“fast, but you may not want to do this”.</p>
<section id="reuse-encoders-decoders">
<h2>Reuse Encoders/Decoders<a class="headerlink" href="#reuse-encoders-decoders" title="Link to this heading">¶</a></h2>
<p>Every call to a top-level <code class="docutils literal notranslate"><span class="pre">encode</span></code> function like <a class="reference internal" href="api.html#msgspec.json.encode" title="msgspec.json.encode"><code class="xref py py-obj docutils literal notranslate"><span class="pre">msgspec.json.encode</span></code></a>
allocates some temporary internal state used for encoding. While fine for
normal use, for maximum performance you’ll want to create an <code class="docutils literal notranslate"><span class="pre">Encoder</span></code> (e.g.
<a class="reference internal" href="api.html#msgspec.json.Encoder" title="msgspec.json.Encoder"><code class="xref py py-obj docutils literal notranslate"><span class="pre">msgspec.json.Encoder</span></code></a>) once and reuse it for all encoding calls, avoiding
paying that setup cost for every call.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span><span class="w"> </span><span class="nn">msgspec</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">encoder</span> <span class="o">=</span> <span class="n">msgspec</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">Encoder</span><span class="p">()</span>  <span class="c1"># Create once</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">msgs</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">data</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>  <span class="c1"># reuse multiple times</span>
</pre></div>
</div>
<p>The same goes for decoding. If you’re making multiple <code class="docutils literal notranslate"><span class="pre">decode</span></code> calls in a
performance-sensitive code path, you’ll want to create a <code class="docutils literal notranslate"><span class="pre">Decoder</span></code> (e.g.
<a class="reference internal" href="api.html#msgspec.json.Decoder" title="msgspec.json.Decoder"><code class="xref py py-obj docutils literal notranslate"><span class="pre">msgspec.json.Decoder</span></code></a>) once and reuse it for each call. Since decoders are
typed, you may need to create multiple decoders, one for each type.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span><span class="w"> </span><span class="nn">msgspec</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">decoder</span> <span class="o">=</span> <span class="n">msgspec</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span>  <span class="c1"># Create once</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">input_buffers</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">msg</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># reuse multiple times</span>
</pre></div>
</div>
</section>
<section id="use-structs">
<h2>Use Structs<a class="headerlink" href="#use-structs" title="Link to this heading">¶</a></h2>
<p><a class="reference internal" href="structs.html"><span class="doc">Structs</span></a> are msgspec’s native way of expressing user-defined types.
They’re <a class="reference internal" href="benchmarks.html#json-benchmark"><span class="std std-ref">fast to encode/decode</span></a> and <a class="reference internal" href="benchmarks.html#struct-benchmark"><span class="std std-ref">fast to use</span></a>. If you have data with a known schema, we recommend
defining a <a class="reference internal" href="api.html#msgspec.Struct" title="msgspec.Struct"><code class="xref py py-obj docutils literal notranslate"><span class="pre">msgspec.Struct</span></code></a> type (or types) for your schema and preferring that
over other types like <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict" title="(in Python v3.13)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">dict</span></code></a>/<a class="reference external" href="https://docs.python.org/3/library/dataclasses.html#module-dataclasses" title="(in Python v3.13)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">dataclasses</span></code></a>/…</p>
</section>
<section id="avoid-encoding-default-values">
<h2>Avoid Encoding Default Values<a class="headerlink" href="#avoid-encoding-default-values" title="Link to this heading">¶</a></h2>
<p>By default, <code class="docutils literal notranslate"><span class="pre">msgspec</span></code> encodes all fields in a Struct type, including optional
fields (those configured with a default value). If the default values are known
on the decoding end (making serializing them redundant), it may be beneficial
to omit default values from the encoded message. This can be done by
configuring <code class="docutils literal notranslate"><span class="pre">omit_defaults=True</span></code> as part of the Struct definition Omitting
defaults reduces the size of the encoded message, and often also improves
encoding and decoding performance (since there’s less work to do).</p>
<p>For more information, see <a class="reference internal" href="structs.html#omit-defaults"><span class="std std-ref">Omitting Default Values</span></a>.</p>
</section>
<section id="avoid-decoding-unused-fields">
<span id="id1"></span><h2>Avoid Decoding Unused Fields<a class="headerlink" href="#avoid-decoding-unused-fields" title="Link to this heading">¶</a></h2>
<p>When decoding large inputs, sometimes you’re only interested in a few specific
fields. Since decoding large objects is inherently allocation heavy, it may be
beneficial to define a smaller <a class="reference internal" href="api.html#msgspec.Struct" title="msgspec.Struct"><code class="xref py py-obj docutils literal notranslate"><span class="pre">msgspec.Struct</span></code></a> type that only has the fields
you require.</p>
<p>For example, say you’re interested in decoding some JSON from the <a class="reference external" href="https://developer.twitter.com/en/docs/twitter-api/v1/data-dictionary/object-model/tweet">Twitter API</a>.
A <code class="docutils literal notranslate"><span class="pre">Tweet</span></code> object has many nested fields on it - perhaps you only care about
the tweet text, the user name, and the number of favorites. By defining struct
types with only those fields, <code class="docutils literal notranslate"><span class="pre">msgspec</span></code> can avoid doing unnecessary work
decoding fields that are never used.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span><span class="w"> </span><span class="nn">msgspec</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">msgspec</span><span class="o">.</span><span class="n">Struct</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span><span class="w"> </span><span class="nc">Tweet</span><span class="p">(</span><span class="n">msgspec</span><span class="o">.</span><span class="n">Struct</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">user</span><span class="p">:</span> <span class="n">User</span>
<span class="gp">... </span>    <span class="n">full_text</span><span class="p">:</span> <span class="nb">str</span>
<span class="gp">... </span>    <span class="n">favorite_count</span><span class="p">:</span> <span class="nb">int</span>
</pre></div>
</div>
<p>We can then use these types to decode the <a class="reference external" href="https://developer.twitter.com/en/docs/twitter-api/v1/data-dictionary/object-model/example-payloads">example tweet json</a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">tweet</span> <span class="o">=</span> <span class="n">msgspec</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">example_json</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">Tweet</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">tweet</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span>
<span class="go">&#39;Twitter Dev&#39;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">tweet</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">favorite_count</span>
<span class="go">70</span>
</pre></div>
</div>
<p>Of course there are downsides to defining smaller “view” types, but if decoding
performance is a bottleneck in your workflow, you may benefit from this
technique.</p>
<p>For a more in-depth example of this technique, see the
<a class="reference internal" href="examples/conda-repodata.html"><span class="doc">Conda Repodata</span></a> example.</p>
</section>
<section id="reduce-allocations">
<h2>Reduce Allocations<a class="headerlink" href="#reduce-allocations" title="Link to this heading">¶</a></h2>
<p>Every call to <code class="docutils literal notranslate"><span class="pre">encode</span></code>/<code class="docutils literal notranslate"><span class="pre">Encoder.encode</span></code> allocates a new <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#bytes" title="(in Python v3.13)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">bytes</span></code></a> object for
the output. <code class="docutils literal notranslate"><span class="pre">msgspec</span></code> exposes an alternative <code class="docutils literal notranslate"><span class="pre">Encoder.encode_into</span></code> (e.g.
<a class="reference internal" href="api.html#msgspec.json.Encoder.encode_into" title="msgspec.json.Encoder.encode_into"><code class="xref py py-obj docutils literal notranslate"><span class="pre">msgspec.json.Encoder.encode_into</span></code></a>) that writes into a pre-allocated
<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#bytearray" title="(in Python v3.13)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">bytearray</span></code></a> instead (possibly reallocating to increase capacity).</p>
<p>This has a few uses:</p>
<section id="reusing-an-output-buffer">
<h3>Reusing an output buffer<a class="headerlink" href="#reusing-an-output-buffer" title="Link to this heading">¶</a></h3>
<p>If you’re encoding and writing messages to a socket/file in a hot loop, you
<em>may</em> benefit from allocating a single <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#bytearray" title="(in Python v3.13)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">bytearray</span></code></a> buffer once and reusing it
for every message.</p>
<p>For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">encoder</span> <span class="o">=</span> <span class="n">msgspec</span><span class="o">.</span><span class="n">msgpack</span><span class="o">.</span><span class="n">Encoder</span><span class="p">()</span>

<span class="c1"># Allocate a single shared buffer</span>
<span class="n">buffer</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>

<span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">msgs</span><span class="p">:</span>
    <span class="c1"># Encode a message into the buffer at the start of the buffer.</span>
    <span class="c1"># Note that this overwrites any previous contents.</span>
    <span class="n">encoder</span><span class="o">.</span><span class="n">encode_into</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">buffer</span><span class="p">)</span>

    <span class="c1"># Write the buffer to the socket</span>
    <span class="n">socket</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
</pre></div>
</div>
<p>A few caveats:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Encoder.encode_into</span></code> will expand the capacity of <code class="docutils literal notranslate"><span class="pre">buffer</span></code> as needed to
fit the message size. This means that if a large message is encountered the
buffer will be expanded to be equally large, but won’t be reduced back to
normal afterwards (possibly bloating memory usage). You can use
<a class="reference external" href="https://docs.python.org/3/library/sys.html#sys.getsizeof" title="(in Python v3.13)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">sys.getsizeof</span></code></a> (or call <code class="xref py py-obj docutils literal notranslate"><span class="pre">bytearray.__sizeof__</span></code>) directly to determine the
actual capacity of the buffer, since <code class="docutils literal notranslate"><span class="pre">len(buffer)</span></code> will only reflect the
part of the buffer that is written to.</p></li>
<li><p>Small messages (for some definition of “small”) likely won’t see a
performance improvement from using this method, and may instead see a
slowdown. We recommend using a realistic benchmark to determine if this
method can benefit your workload.</p></li>
</ul>
</section>
<section id="line-delimited-json">
<h3>Line-Delimited JSON<a class="headerlink" href="#line-delimited-json" title="Link to this heading">¶</a></h3>
<p>Some protocols require appending a suffix to an encoded message. One place
where this comes up is when encoding <a class="reference external" href="https://en.wikipedia.org/wiki/JSON_streaming#Line-delimited_JSON">line-delimited JSON</a>, where every
payload contains a JSON message followed by <code class="docutils literal notranslate"><span class="pre">b&quot;\n&quot;</span></code>.</p>
<p>This <em>could</em> be handled in python as:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">msgspec</span>

<span class="n">json_msg</span> <span class="o">=</span> <span class="n">msgspec</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">encode</span><span class="p">([</span><span class="s2">&quot;my&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">])</span>

<span class="n">full_payload</span> <span class="o">=</span> <span class="n">json_msg</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
</pre></div>
</div>
<p>However, this results in an unnecessary copy of <code class="docutils literal notranslate"><span class="pre">json_msg</span></code>, which can be
avoided by using <a class="reference internal" href="api.html#msgspec.json.Encoder.encode_into" title="msgspec.json.Encoder.encode_into"><code class="xref py py-obj docutils literal notranslate"><span class="pre">msgspec.json.Encoder.encode_into</span></code></a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">msgspec</span>

<span class="n">encoder</span> <span class="o">=</span> <span class="n">msgspec</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">Encoder</span><span class="p">()</span>

<span class="c1"># Allocate a buffer. We recommend using a small non-empty buffer to</span>
<span class="c1"># avoid reallocating for small messages. Choose something larger than</span>
<span class="c1"># your common message size, but not excessively large.</span>
<span class="n">buffer</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>

<span class="c1"># Encode into the existing buffer.</span>
<span class="n">encoder</span><span class="o">.</span><span class="n">encode_into</span><span class="p">([</span><span class="s2">&quot;my&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">],</span> <span class="n">buffer</span><span class="p">)</span>

<span class="c1"># Append a newline character without copying</span>
<span class="n">buffer</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Write the full buffer to a socket/file/etc...</span>
<span class="n">socket</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="length-prefix-framing">
<h3>Length-Prefix Framing<a class="headerlink" href="#length-prefix-framing" title="Link to this heading">¶</a></h3>
<p>Some protocols require prepending a prefix to an encoded message. This comes up
in <a class="reference external" href="https://eli.thegreenplace.net/2011/08/02/length-prefix-framing-for-protocol-buffers">Length-prefix framing</a>
, where every message is prefixed by its length stored as a fixed-width integer
(e.g. a big-endian uint32). Like line-delimited JSON above, this is more
efficient to do using <code class="docutils literal notranslate"><span class="pre">Encoder.encode_into</span></code> to avoid excessive copying.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">msgspec</span>

<span class="n">encoder</span> <span class="o">=</span> <span class="n">msgspec</span><span class="o">.</span><span class="n">msgpack</span><span class="o">.</span><span class="n">Encoder</span><span class="p">()</span>

<span class="c1"># Allocate a buffer. We recommend using a small non-empty buffer to</span>
<span class="c1"># avoid reallocating for small messages. Choose something larger than</span>
<span class="c1"># your common message size, but not excessively large.</span>
<span class="n">buffer</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>

<span class="c1"># Encode into the existing buffer, offset by 4 bytes at the front to</span>
<span class="c1"># store the length prefix.</span>
<span class="n">encoder</span><span class="o">.</span><span class="n">encode_into</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

<span class="c1"># Encode the message length as a 4 byte big-endian integer, and</span>
<span class="c1"># prefix the message with it (without copying).</span>
<span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span>
<span class="n">buffer</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;big&quot;</span><span class="p">)</span>

<span class="c1"># Write the buffer to a socket/file/etc...</span>
<span class="n">socket</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="use-messagepack">
<h2>Use MessagePack<a class="headerlink" href="#use-messagepack" title="Link to this heading">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">msgspec</span></code> supports both <a class="reference external" href="https://json.org">JSON</a> and <a class="reference external" href="https://msgpack.org">MessagePack</a> protocols. The latter is less
commonly used, but <a class="reference internal" href="benchmarks.html#msgpack-benchmark"><span class="std std-ref">can be more performant</span></a>. If
performance is an issue (and MessagePack is an acceptable solution), you may
benefit from using it instead of JSON. And since <code class="docutils literal notranslate"><span class="pre">msgspec</span></code> supports both
protocols with a consistent interface, switching from <code class="docutils literal notranslate"><span class="pre">msgspec.json</span></code> to
<code class="docutils literal notranslate"><span class="pre">msgspec.msgpack</span></code> should be fairly painless.</p>
</section>
<section id="use-gc-false">
<h2>Use <code class="docutils literal notranslate"><span class="pre">gc=False</span></code><a class="headerlink" href="#use-gc-false" title="Link to this heading">¶</a></h2>
<p>Python processes with a large number of long-lived objects, or operations that
allocate a large number of objects at once may suffer reduced performance due
to Python’s garbage collector (GC). By default, <a class="reference internal" href="api.html#msgspec.Struct" title="msgspec.Struct"><code class="xref py py-obj docutils literal notranslate"><span class="pre">msgspec.Struct</span></code></a> types
implement a few optimizations to reduce the load on the GC (and thus reduce the
frequency and duration of a GC pause). If you find that GC is still a problem,
and <strong>are certain</strong> that your Struct types may never participate in a reference
cycle, then you <strong>may</strong> benefit from setting <code class="docutils literal notranslate"><span class="pre">gc=False</span></code> on your Struct
types.  Depending on workload, this can result in a measurable decrease in
pause time and frequency due to GC passes. See <a class="reference internal" href="structs.html#struct-gc"><span class="std std-ref">Disabling Garbage Collection (Advanced)</span></a> for more
details.</p>
</section>
<section id="use-array-like-true">
<h2>Use <code class="docutils literal notranslate"><span class="pre">array_like=True</span></code><a class="headerlink" href="#use-array-like-true" title="Link to this heading">¶</a></h2>
<p>One touted benefit of <a class="reference external" href="https://json.org">JSON</a> and <a class="reference external" href="https://msgpack.org">MessagePack</a> is that they’re “self-describing”
protocols. JSON objects serialize their field names along with their values. If
both ends of a connection already know the field names though, serializing them
may be an unnecessary cost. If you need higher performance (at the cost of more
inscrutable message encoding), you can set <code class="docutils literal notranslate"><span class="pre">array_like=True</span></code> on a struct
definition. Structs with this option enabled are encoded/decoded like array
types, removing the field names from the encoded message. This can provide on
average another ~2x speedup for decoding (and ~1.5x speedup for encoding).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span><span class="w"> </span><span class="nc">Example</span><span class="p">(</span><span class="n">msgspec</span><span class="o">.</span><span class="n">Struct</span><span class="p">,</span> <span class="n">array_like</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">my_first_field</span><span class="p">:</span> <span class="nb">str</span>
<span class="gp">... </span>    <span class="n">my_second_field</span><span class="p">:</span> <span class="nb">int</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">Example</span><span class="p">(</span><span class="s2">&quot;some string&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">msg</span> <span class="o">=</span> <span class="n">msgspec</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">msg</span>
<span class="go">b&#39;[&quot;some string&quot;,2]&#39;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">msgspec</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">Example</span><span class="p">)</span>
<span class="go">Example(my_first_field=&quot;some string&quot;, my_second_field=2)</span>
</pre></div>
</div>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="api.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">API Docs</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="inspect.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Inspecting Types</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; Jim Crist-Harif
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link " href="https://github.com/jcrist/msgspec" aria-label="GitHub"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path>
</svg></a>
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Performance Tips</a><ul>
<li><a class="reference internal" href="#reuse-encoders-decoders">Reuse Encoders/Decoders</a></li>
<li><a class="reference internal" href="#use-structs">Use Structs</a></li>
<li><a class="reference internal" href="#avoid-encoding-default-values">Avoid Encoding Default Values</a></li>
<li><a class="reference internal" href="#avoid-decoding-unused-fields">Avoid Decoding Unused Fields</a></li>
<li><a class="reference internal" href="#reduce-allocations">Reduce Allocations</a><ul>
<li><a class="reference internal" href="#reusing-an-output-buffer">Reusing an output buffer</a></li>
<li><a class="reference internal" href="#line-delimited-json">Line-Delimited JSON</a></li>
<li><a class="reference internal" href="#length-prefix-framing">Length-Prefix Framing</a></li>
</ul>
</li>
<li><a class="reference internal" href="#use-messagepack">Use MessagePack</a></li>
<li><a class="reference internal" href="#use-gc-false">Use <code class="docutils literal notranslate"><span class="pre">gc=False</span></code></a></li>
<li><a class="reference internal" href="#use-array-like-true">Use <code class="docutils literal notranslate"><span class="pre">array_like=True</span></code></a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="_static/documentation_options.js?v=5929fcd5"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/scripts/furo.js?v=5fa4622c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=de5a9c30"></script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    </body>
</html>