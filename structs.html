<!doctype html>
<html class="no-js" lang="en">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />
<link rel="index" title="Index" href="genindex.html" /><link rel="search" title="Search" href="search.html" /><link rel="next" title="Extending" href="extending.html" /><link rel="prev" title="Usage" href="usage.html" />

    <meta name="generator" content="sphinx-5.0.2, furo 2022.06.21"/>
        <title>Structs</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo.css?digest=40978830699223671f4072448e654b5958f38b89" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="index.html"><div class="brand">msgspec</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo only-light" src="_static/msgspec-logo-light.svg" alt="Light Logo"/>
    <img class="sidebar-logo only-dark" src="_static/msgspec-logo-dark.svg" alt="Dark Logo"/>
  </div>
  
  
</a><form class="sidebar-search-container" method="get" action="search.html" role="search">
  <input class="sidebar-search" placeholder=Search name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="usage.html">Usage</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Structs</a></li>
<li class="toctree-l1"><a class="reference internal" href="extending.html">Extending</a></li>
<li class="toctree-l1"><a class="reference internal" href="perf-tips.html">Performance Tips</a></li>
<li class="toctree-l1"><a class="reference internal" href="benchmarks.html">Benchmarks</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="examples/index.html">Examples</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="examples/geojson.html">GeoJSON</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="structs">
<h1>Structs<a class="headerlink" href="#structs" title="Permalink to this heading">#</a></h1>
<p>Structs are the preferred way of defining structured data types in <code class="docutils literal notranslate"><span class="pre">msgspec</span></code>.
They’re written in C and are quite speedy and lightweight (<a class="reference internal" href="benchmarks.html"><span class="doc">measurably
faster</span></a> to create/compare/encode/decode than similar options like
<a class="reference external" href="https://docs.python.org/3/library/dataclasses.html">dataclasses</a>, <a class="reference external" href="https://www.attrs.org/en/stable/index.html">attrs</a>, or <a class="reference external" href="https://pydantic-docs.helpmanual.io/">pydantic</a>). They’re great for representing structured
data both for serialization and for use in an application.</p>
<p>Structs are defined by subclassing from <a class="reference internal" href="api.html#msgspec.Struct" title="msgspec.Struct"><code class="xref py py-obj docutils literal notranslate"><span class="pre">msgspec.Struct</span></code></a> and annotating the
types of individual fields. Default values can also be provided for any
optional arguments. Here we define a struct representing a user, with one
required field and two optional fields.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">msgspec</span>

<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Optional</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">msgspec</span><span class="o">.</span><span class="n">Struct</span><span class="p">):</span>
<span class="gp">... </span>    <span class="sd">&quot;&quot;&quot;A struct describing a user&quot;&quot;&quot;</span>
<span class="gp">... </span>    <span class="n">name</span> <span class="p">:</span> <span class="nb">str</span>
<span class="gp">... </span>    <span class="n">email</span> <span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="gp">... </span>    <span class="n">groups</span> <span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">name</span></code> is a <em>required</em> field expecting a <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">str</span></code></a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">email</span></code> is an <em>optional</em> field expecting a <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">str</span></code></a> or <a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">None</span></code></a>, defaulting to
<a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">None</span></code></a> if no value is provided.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">groups</span></code> is an <em>optional</em> field expecting a <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#set" title="(in Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">set</span></code></a> of <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">str</span></code></a>. If no value is
provided, it defaults to the empty set (note that mutable default values are
deep-copied before use).</p></li>
</ul>
<p>Struct types automatically generate a few methods based on the provided type
annotations:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">__init__</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">__repr__</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">__copy__</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">__eq__</span></code> &amp; <code class="docutils literal notranslate"><span class="pre">__ne__</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">__match_args__</span></code> (for Python 3.10+’s <a class="reference external" href="https://docs.python.org/3/reference/compound_stmts.html#the-match-statement">pattern matching</a>)</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">alice</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;admin&quot;</span><span class="p">,</span> <span class="s2">&quot;engineering&quot;</span><span class="p">})</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">alice</span>
<span class="go">User(name=&#39;alice&#39;, email=None, groups={&#39;admin&#39;, &#39;engineering&#39;})</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">bob</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="s2">&quot;bob&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;bob@company.com&quot;</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">bob</span>
<span class="go">User(name=&#39;bob&#39;, email=&#39;bob@company.com&#39;, groups=set())</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">alice</span><span class="o">.</span><span class="n">name</span>
<span class="go">&quot;alice&quot;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">bob</span><span class="o">.</span><span class="n">groups</span>
<span class="go">set()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">alice</span> <span class="o">==</span> <span class="n">bob</span>
<span class="go">False</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">alice</span> <span class="o">==</span> <span class="n">User</span><span class="p">(</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;admin&quot;</span><span class="p">,</span> <span class="s2">&quot;engineering&quot;</span><span class="p">})</span>
<span class="go">True</span>
</pre></div>
</div>
<p>Note that it is forbidden to override <code class="docutils literal notranslate"><span class="pre">__init__</span></code>/<code class="docutils literal notranslate"><span class="pre">__new__</span></code> in a struct
definition, but other methods can be overridden or added as needed.</p>
<p>The struct fields are available via the <code class="docutils literal notranslate"><span class="pre">__struct_fields__</span></code> attribute (a
tuple of the fields in argument order ) if you need them. Here we add a method
for converting a struct to a dict.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">Point</span><span class="p">(</span><span class="n">msgspec</span><span class="o">.</span><span class="n">Struct</span><span class="p">):</span>
<span class="gp">... </span>    <span class="sd">&quot;&quot;&quot;A point in 2D space&quot;&quot;&quot;</span>
<span class="gp">... </span>    <span class="n">x</span> <span class="p">:</span> <span class="nb">float</span>
<span class="gp">... </span>    <span class="n">y</span> <span class="p">:</span> <span class="nb">float</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="p">{</span><span class="n">f</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__struct_fields__</span><span class="p">}</span>
<span class="gp">...</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
<span class="go">{&quot;x&quot;: 1.0, &quot;y&quot;: 2.0}</span>
</pre></div>
</div>
<section id="type-validation">
<h2>Type Validation<a class="headerlink" href="#type-validation" title="Permalink to this heading">#</a></h2>
<p>Unlike some other libraries (e.g. <a class="reference external" href="https://pydantic-docs.helpmanual.io/">pydantic</a>), the type annotations on a
<a class="reference internal" href="api.html#msgspec.Struct" title="msgspec.Struct"><code class="xref py py-obj docutils literal notranslate"><span class="pre">msgspec.Struct</span></code></a> class are not checked at runtime during normal use. Types are
only checked when <em>decoding</em> a serialized message when using a <code class="xref py py-obj docutils literal notranslate"><span class="pre">typed</span> <span class="pre">decoder</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">msgspec</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">Point</span><span class="p">(</span><span class="n">msgspec</span><span class="o">.</span><span class="n">Struct</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">x</span><span class="p">:</span> <span class="nb">float</span>
<span class="gp">... </span>    <span class="n">y</span><span class="p">:</span> <span class="nb">float</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Improper types in *your* code aren&#39;t checked at runtime</span>
<span class="gp">... </span><span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;oops&quot;</span><span class="p">)</span>
<span class="go">Point(x=1, y=&#39;oops&#39;)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Improper types when decoding *are* checked at runtime</span>
<span class="gp">... </span><span class="n">msgspec</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;{&quot;x&quot;: 1.0, &quot;y&quot;: &quot;oops&quot;}&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">Point</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
  File <span class="nb">&quot;&lt;stdin&gt;&quot;</span>, line <span class="m">1</span>, in <span class="n">&lt;module&gt;</span>
<span class="gr">msgspec.DecodeError</span>: <span class="n">Expected `float`, got `str` - at `$.y`</span>
</pre></div>
</div>
<p>This is intentional. Static type checkers like <a class="reference external" href="https://mypy.readthedocs.io/en/stable/">mypy</a>/<a class="reference external" href="https://github.com/microsoft/pyright">pyright</a> work well with
<code class="docutils literal notranslate"><span class="pre">msgspec</span></code>, and can be used to catch bugs without ever running your code. When
possible, static tools or unit tests should be preferred over adding expensive
runtime checks which slow down every <code class="docutils literal notranslate"><span class="pre">__init__</span></code> call.</p>
<p>The input(s) to your programs however cannot be checked statically, as they
aren’t known until runtime. As such, <code class="docutils literal notranslate"><span class="pre">msgspec</span></code> does perform type validation
when decoding messages (provided an expected decode type is provided). This
validation is fast enough that it is <em>negligible in cost</em> - there is no added
performance benefit when not using it. In fact, in most cases it’s faster to
decode a message into a type validated <a class="reference internal" href="api.html#msgspec.Struct" title="msgspec.Struct"><code class="xref py py-obj docutils literal notranslate"><span class="pre">msgspec.Struct</span></code></a> than into an untyped
<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict" title="(in Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">dict</span></code></a>.</p>
</section>
<section id="pattern-matching">
<h2>Pattern Matching<a class="headerlink" href="#pattern-matching" title="Permalink to this heading">#</a></h2>
<p>If using Python 3.10+, <a class="reference internal" href="api.html#msgspec.Struct" title="msgspec.Struct"><code class="xref py py-obj docutils literal notranslate"><span class="pre">msgspec.Struct</span></code></a> types can be used in <a class="reference external" href="https://docs.python.org/3/reference/compound_stmts.html#the-match-statement">pattern matching</a>
blocks. Replicating an example from <a class="reference external" href="https://www.python.org/dev/peps/pep-0636/">PEP 636</a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># NOTE: this example requires Python 3.10+</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">msgspec</span>

<span class="o">&gt;&gt;&gt;</span> <span class="k">class</span> <span class="nc">Point</span><span class="p">(</span><span class="n">msgspec</span><span class="o">.</span><span class="n">Struct</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">x</span><span class="p">:</span> <span class="nb">float</span>
<span class="o">...</span>     <span class="n">y</span><span class="p">:</span> <span class="nb">float</span>

<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">where_is</span><span class="p">(</span><span class="n">point</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">match</span> <span class="n">point</span><span class="p">:</span>
<span class="o">...</span>         <span class="n">case</span> <span class="n">Point</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
<span class="o">...</span>             <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Origin&quot;</span><span class="p">)</span>
<span class="o">...</span>         <span class="n">case</span> <span class="n">Point</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="o">...</span>             <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Y=</span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="o">...</span>         <span class="n">case</span> <span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
<span class="o">...</span>             <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;X=</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="o">...</span>         <span class="n">case</span> <span class="n">Point</span><span class="p">():</span>
<span class="o">...</span>             <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Somewhere else&quot;</span><span class="p">)</span>
<span class="o">...</span>         <span class="n">case</span> <span class="n">_</span><span class="p">:</span>
<span class="o">...</span>             <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Not a point&quot;</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">where_is</span><span class="p">(</span><span class="n">Point</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="s2">&quot;Y=6&quot;</span>
</pre></div>
</div>
</section>
<section id="equality-and-order">
<h2>Equality and Order<a class="headerlink" href="#equality-and-order" title="Permalink to this heading">#</a></h2>
<p>By default struct types define an <code class="docutils literal notranslate"><span class="pre">__eq__</span></code> method based on the type
definition. This enables support for equality comparisons. Additionally, you
may configure <code class="docutils literal notranslate"><span class="pre">order=True</span></code> to make a struct type <em>orderable</em> through
generation of <code class="docutils literal notranslate"><span class="pre">__lt__</span></code>, <code class="docutils literal notranslate"><span class="pre">__le__</span></code>, <code class="docutils literal notranslate"><span class="pre">__gt__</span></code>, and <code class="docutils literal notranslate"><span class="pre">__ge__</span></code> methods. These
methods compare and order instances of a struct type the same as if they were
tuples of their field values (in definition order).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">Point</span><span class="p">(</span><span class="n">msgspec</span><span class="o">.</span><span class="n">Struct</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">x</span><span class="p">:</span> <span class="nb">float</span>
<span class="gp">... </span>    <span class="n">y</span><span class="p">:</span> <span class="nb">float</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">Point</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="n">Point</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="go">True</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">Point</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">Point</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="go">True</span>
</pre></div>
</div>
<p>In <em>rare</em> instances you may opt to disable generation of the <code class="docutils literal notranslate"><span class="pre">__eq__</span></code> method
by configuring <code class="docutils literal notranslate"><span class="pre">eq=False</span></code>.  Equality checks will then fall back to <em>identity
comparisons</em>, where the only value a struct instance of that type will compare
equal to is itself.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">Point</span><span class="p">(</span><span class="n">msgspec</span><span class="o">.</span><span class="n">Struct</span><span class="p">,</span> <span class="n">eq</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">x</span><span class="p">:</span> <span class="nb">float</span>
<span class="gp">... </span>    <span class="n">y</span><span class="p">:</span> <span class="nb">float</span>


<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span> <span class="o">==</span> <span class="n">Point</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="go">False</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span> <span class="o">==</span> <span class="n">p</span>  <span class="c1"># identity comparison only</span>
<span class="go">True</span>
</pre></div>
</div>
</section>
<section id="frozen-instances">
<h2>Frozen Instances<a class="headerlink" href="#frozen-instances" title="Permalink to this heading">#</a></h2>
<p>A struct type can optionally be marked as “frozen” by specifying
<code class="docutils literal notranslate"><span class="pre">frozen=True</span></code>. This disables modifying attributes after initialization, and
adds a <code class="docutils literal notranslate"><span class="pre">__hash__</span></code> method to the class definition. Note that for the
<code class="docutils literal notranslate"><span class="pre">__hash__</span></code> to work, all fields on the struct must also be hashable.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">Point</span><span class="p">(</span><span class="n">msgspec</span><span class="o">.</span><span class="n">Struct</span><span class="p">,</span> <span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="gp">... </span>    <span class="sd">&quot;&quot;&quot;This struct is immutable &amp; hashable&quot;&quot;&quot;</span>
<span class="gp">... </span>    <span class="n">x</span><span class="p">:</span> <span class="nb">float</span>
<span class="gp">... </span>    <span class="n">y</span><span class="p">:</span> <span class="nb">float</span>
<span class="gp">...</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="p">{</span><span class="n">p</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>  <span class="c1"># frozen structs are hashable, and can be keys in dicts</span>
<span class="go">{Point(1.0, 2.0): 1}</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mf">2.0</span>  <span class="c1"># frozen structs cannot be modified after creation</span>
<span class="gt">Traceback (most recent call last):</span>
    <span class="o">...</span>
<span class="gr">AttributeError</span>: <span class="n">immutable type: &#39;Point&#39;</span>
</pre></div>
</div>
</section>
<section id="tagged-unions">
<span id="struct-tagged-unions"></span><h2>Tagged Unions<a class="headerlink" href="#tagged-unions" title="Permalink to this heading">#</a></h2>
<p>By default a serialized struct only contains information on the <em>values</em>
present in the struct instance - no information is serialized noting which
struct type corresponds to the message. Instead, the user is expected to
know the type the message corresponds to, and pass that information
appropriately to the decoder.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">msgspec</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">Get</span><span class="p">(</span><span class="n">msgspec</span><span class="o">.</span><span class="n">Struct</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">key</span><span class="p">:</span> <span class="nb">str</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">msg</span> <span class="o">=</span> <span class="n">msgspec</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">Get</span><span class="p">(</span><span class="s2">&quot;my key&quot;</span><span class="p">))</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">msg</span>  <span class="c1"># No type information present in the message</span>
<span class="go">b&#39;{&quot;key&quot;:&quot;my key&quot;}&#39;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">msgspec</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">Get</span><span class="p">)</span>
<span class="go">Get(key=&#39;my key&#39;)</span>
</pre></div>
</div>
<p>In most cases this works well - schemas are often simple and each value may
only correspond to at most one Struct type. However, sometimes you may have a
message (or a field in a message) that may contain one of a number of different
structured types. In this case we need some way to determine the type of the
message from the message itself!</p>
<p><code class="docutils literal notranslate"><span class="pre">msgspec</span></code> handles this through the use of <a class="reference external" href="https://en.wikipedia.org/wiki/Tagged_union">Tagged Unions</a>. A new field (the
“tag field”) is added to the serialized representation of all struct types in
the union. Each struct type associates a different value (the “tag”) with this
field. When the decoder encounters a tagged union it decodes the tag first and
uses it to determine the type to use when decoding the rest of the object. This
process is efficient and makes determining the type of a serialized message
unambiguous.</p>
<p>The quickest way to enable tagged unions is to set <code class="docutils literal notranslate"><span class="pre">tag=True</span></code> when defining
every struct type in the union. In this case <code class="docutils literal notranslate"><span class="pre">tag_field</span></code> defaults to
<code class="docutils literal notranslate"><span class="pre">&quot;type&quot;</span></code>, and <code class="docutils literal notranslate"><span class="pre">tag</span></code> defaults to the struct class name (e.g. <code class="docutils literal notranslate"><span class="pre">&quot;Get&quot;</span></code>).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">msgspec</span>

<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Pass in ``tag=True`` to tag the structs using the default configuration</span>
<span class="gp">... </span><span class="k">class</span> <span class="nc">Get</span><span class="p">(</span><span class="n">msgspec</span><span class="o">.</span><span class="n">Struct</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">key</span><span class="p">:</span> <span class="nb">str</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">Put</span><span class="p">(</span><span class="n">msgspec</span><span class="o">.</span><span class="n">Struct</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">key</span><span class="p">:</span> <span class="nb">str</span>
<span class="gp">... </span>    <span class="n">val</span><span class="p">:</span> <span class="nb">str</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">msg</span> <span class="o">=</span> <span class="n">msgspec</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">Get</span><span class="p">(</span><span class="s2">&quot;my key&quot;</span><span class="p">))</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">msg</span>  <span class="c1"># &quot;type&quot; is the tag field, &quot;Get&quot; is the tag</span>
<span class="go">b&#39;{&quot;type&quot;:&quot;Get&quot;,&quot;key&quot;:&quot;my key&quot;}&#39;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Create a decoder for decoding either Get or Put</span>
<span class="gp">... </span><span class="n">dec</span> <span class="o">=</span> <span class="n">msgspec</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="n">Union</span><span class="p">[</span><span class="n">Get</span><span class="p">,</span> <span class="n">Put</span><span class="p">])</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># The tag value is used to determine the message type</span>
<span class="gp">... </span><span class="n">dec</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;{&quot;type&quot;: &quot;Put&quot;, &quot;key&quot;: &quot;my key&quot;, &quot;val&quot;: &quot;my val&quot;}&#39;</span><span class="p">)</span>
<span class="go">Put(key=&#39;my key&#39;, val=&#39;my val&#39;)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">dec</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;{&quot;type&quot;: &quot;Get&quot;, &quot;key&quot;: &quot;my key&quot;}&#39;</span><span class="p">)</span>
<span class="go">Get(key=&#39;my key&#39;)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># A tagged union can also contain non-struct types.</span>
<span class="gp">... </span><span class="n">msgspec</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
<span class="gp">... </span>    <span class="sa">b</span><span class="s1">&#39;123&#39;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="nb">type</span><span class="o">=</span><span class="n">Union</span><span class="p">[</span><span class="n">Get</span><span class="p">,</span> <span class="n">Put</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
<span class="gp">... </span><span class="p">)</span>
<span class="go">123</span>
</pre></div>
</div>
<p>If you want to change this behavior to use a different tag field and/or value,
you can further configure things through the <code class="docutils literal notranslate"><span class="pre">tag_field</span></code> and <code class="docutils literal notranslate"><span class="pre">tag</span></code> kwargs.
A struct’s tagging configuration is determined as follows.</p>
<ul class="simple">
<li><p>If <code class="docutils literal notranslate"><span class="pre">tag</span></code> and <code class="docutils literal notranslate"><span class="pre">tag_field</span></code> are <code class="docutils literal notranslate"><span class="pre">None</span></code> (the default), or <code class="docutils literal notranslate"><span class="pre">tag=False</span></code>,
then the struct is considered “untagged”. The struct is serialized with only
its standard fields, and cannot participate in <code class="docutils literal notranslate"><span class="pre">Union</span></code> types with other
structs.</p></li>
<li><p>If either <code class="docutils literal notranslate"><span class="pre">tag</span></code> or <code class="docutils literal notranslate"><span class="pre">tag_field</span></code> are non-None, then the struct is
considered “tagged”. The struct is serialized with an additional field (the
<code class="docutils literal notranslate"><span class="pre">tag_field</span></code>) mapping to its corresponding <code class="docutils literal notranslate"><span class="pre">tag</span></code> value. It can participate
in <code class="docutils literal notranslate"><span class="pre">Union</span></code> types with other structs, provided they all share the same
<code class="docutils literal notranslate"><span class="pre">tag_field</span></code> and have unique <code class="docutils literal notranslate"><span class="pre">tag</span></code> values.</p></li>
<li><p>If a struct is tagged, <code class="docutils literal notranslate"><span class="pre">tag_field</span></code> defaults to <code class="docutils literal notranslate"><span class="pre">&quot;type&quot;</span></code> if not provided
or inherited. This can be overridden by passing a tag field explicitly (e.g.
<code class="docutils literal notranslate"><span class="pre">tag_field=&quot;kind&quot;</span></code>). Note that <code class="docutils literal notranslate"><span class="pre">tag_field</span></code> must not conflict with any
other field names in the struct, and must be the same for all struct types in
a union.</p></li>
<li><p>If a struct is tagged, <code class="docutils literal notranslate"><span class="pre">tag</span></code> defaults to the class name (e.g. <code class="docutils literal notranslate"><span class="pre">&quot;Get&quot;</span></code>) if
not provided or inherited. This can be overridden by passing a string (or
less commonly an integer) value explicitly (e.g. <code class="docutils literal notranslate"><span class="pre">tag=&quot;get&quot;</span></code>).  <code class="docutils literal notranslate"><span class="pre">tag</span></code> can
also be passed a callable that takes the class name and returns a valid tag
value (e.g. <code class="docutils literal notranslate"><span class="pre">tag=str.lower</span></code>). Note that tag values must be unique for all
struct types in a union, and <code class="docutils literal notranslate"><span class="pre">str</span></code> and <code class="docutils literal notranslate"><span class="pre">int</span></code> tag types cannot both be
used within the same union.</p></li>
</ul>
<p>If you like subclassing, both <code class="docutils literal notranslate"><span class="pre">tag_field</span></code> and <code class="docutils literal notranslate"><span class="pre">tag</span></code> are inheritable by
subclasses, allowing configuration to be set once on a base class and reused
for all struct types you wish to tag.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">msgspec</span>

<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Create a base class for tagged structs, where:</span>
<span class="gp">... </span><span class="c1"># - the tag field is &quot;op&quot;</span>
<span class="gp">... </span><span class="c1"># - the tag is the class name lowercased</span>
<span class="gp">... </span><span class="k">class</span> <span class="nc">TaggedBase</span><span class="p">(</span><span class="n">msgspec</span><span class="o">.</span><span class="n">Struct</span><span class="p">,</span> <span class="n">tag_field</span><span class="o">=</span><span class="s2">&quot;op&quot;</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">pass</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Use the base class to pass on the configuration</span>
<span class="gp">... </span><span class="k">class</span> <span class="nc">Get</span><span class="p">(</span><span class="n">TaggedBase</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">key</span><span class="p">:</span> <span class="nb">str</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">Put</span><span class="p">(</span><span class="n">TaggedBase</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">key</span><span class="p">:</span> <span class="nb">str</span>
<span class="gp">... </span>    <span class="n">val</span><span class="p">:</span> <span class="nb">str</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">msg</span> <span class="o">=</span> <span class="n">msgspec</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">Get</span><span class="p">(</span><span class="s2">&quot;my key&quot;</span><span class="p">))</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">msg</span>  <span class="c1"># &quot;op&quot; is the tag field, &quot;get&quot; is the tag</span>
<span class="go">b&#39;{&quot;op&quot;:&quot;get&quot;,&quot;key&quot;:&quot;my key&quot;}&#39;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Create a decoder for decoding either Get or Put</span>
<span class="gp">... </span><span class="n">dec</span> <span class="o">=</span> <span class="n">msgspec</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">Decoder</span><span class="p">(</span><span class="n">Union</span><span class="p">[</span><span class="n">Get</span><span class="p">,</span> <span class="n">Put</span><span class="p">])</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># The tag value is used to determine the message type</span>
<span class="gp">... </span><span class="n">dec</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;{&quot;op&quot;: &quot;put&quot;, &quot;key&quot;: &quot;my key&quot;, &quot;val&quot;: &quot;my val&quot;}&#39;</span><span class="p">)</span>
<span class="go">Put(key=&#39;my key&#39;, val=&#39;my val&#39;)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">dec</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;{&quot;op&quot;: &quot;get&quot;, &quot;key&quot;: &quot;my key&quot;}&#39;</span><span class="p">)</span>
<span class="go">Get(key=&#39;my key&#39;)</span>
</pre></div>
</div>
</section>
<section id="omitting-default-values">
<span id="omit-defaults"></span><h2>Omitting Default Values<a class="headerlink" href="#omitting-default-values" title="Permalink to this heading">#</a></h2>
<p>By default, <code class="docutils literal notranslate"><span class="pre">msgspec</span></code> encodes all fields in a Struct type, including optional
fields (those configured with a default value).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">msgspec</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">msgspec</span><span class="o">.</span><span class="n">Struct</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">name</span> <span class="p">:</span> <span class="nb">str</span>
<span class="gp">... </span>    <span class="n">email</span> <span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="gp">... </span>    <span class="n">groups</span> <span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">alice</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="s2">&quot;alice&quot;</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">alice</span>  <span class="c1"># email &amp; groups are using the default values</span>
<span class="go">User(name=&#39;alice&#39;, email=None, groups=set())</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">msgspec</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">alice</span><span class="p">)</span>  <span class="c1"># default values are present in encoded message</span>
<span class="go">b&#39;{&quot;name&quot;:&quot;alice&quot;,&quot;email&quot;:null,&quot;groups&quot;:[]}&#39;</span>
</pre></div>
</div>
<p>If the default values are known on the decoding end (making serializing them
redundant), it may be beneficial and desired to omit default values from the
encoded message. This can be done by configuring <code class="docutils literal notranslate"><span class="pre">omit_defaults=True</span></code> as part
of the Struct definition:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">msgspec</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">msgspec</span><span class="o">.</span><span class="n">Struct</span><span class="p">,</span> <span class="n">omit_defaults</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">name</span> <span class="p">:</span> <span class="nb">str</span>
<span class="gp">... </span>    <span class="n">email</span> <span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="gp">... </span>    <span class="n">groups</span> <span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">alice</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="s2">&quot;alice&quot;</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">msgspec</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">alice</span><span class="p">)</span>  <span class="c1"># default values are omitted</span>
<span class="go">b&#39;{&quot;name&quot;:&quot;alice&quot;}&#39;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">bob</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="s2">&quot;bob&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;bob@company.com&quot;</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">msgspec</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">bob</span><span class="p">)</span>
<span class="go">b&#39;{&quot;name&quot;:&quot;bob&quot;,&quot;email&quot;:&quot;bob@company.com&quot;}&#39;</span>
</pre></div>
</div>
<p>Omitting defaults reduces the size of the encoded message, and often also
improves encoding and decoding performance (since there’s less work to do).</p>
<p>Note that detection of default values is optimized for performance; in certain
situations a default value may still be encoded. For the curious, the current
detection logic is as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">matches_default</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="gp">... </span>    <span class="sd">&quot;&quot;&quot;Whether a value matches the default for a field&quot;&quot;&quot;</span>
<span class="gp">... </span>    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="n">default</span><span class="p">:</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="kc">True</span>
<span class="gp">... </span>    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="n">default</span><span class="p">):</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="kc">False</span>
<span class="gp">... </span>    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">set</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">default</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="kc">True</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="kc">False</span>
</pre></div>
</div>
</section>
<section id="renaming-field-names">
<h2>Renaming Field Names<a class="headerlink" href="#renaming-field-names" title="Permalink to this heading">#</a></h2>
<p>Sometimes you want the field name used in the encoded message to differ from
the name used your Python code. Perhaps you want a <code class="docutils literal notranslate"><span class="pre">camelCase</span></code> naming
convention in your JSON messages, but to use <code class="docutils literal notranslate"><span class="pre">snake_case</span></code> field names in
Python.</p>
<p>To handle this, <code class="docutils literal notranslate"><span class="pre">msgspec</span></code> supports a <code class="docutils literal notranslate"><span class="pre">rename</span></code> configuration option in
<code class="xref py py-obj docutils literal notranslate"><span class="pre">Struct</span></code> definitions. This can take a few different values:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">None</span></code>: the default, no field renaming (<code class="docutils literal notranslate"><span class="pre">example_field</span></code>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;lower&quot;</span></code>: lowercase all fields (<code class="docutils literal notranslate"><span class="pre">example_field</span></code>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;upper&quot;</span></code>: uppercase all fields (<code class="docutils literal notranslate"><span class="pre">EXAMPLE_FIELD</span></code>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;camel&quot;</span></code>: camelCase all fields (<code class="docutils literal notranslate"><span class="pre">exampleField</span></code>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;pascal&quot;</span></code>: PascalCase all fields (<code class="docutils literal notranslate"><span class="pre">ExampleField</span></code>)</p></li>
<li><p>A callable (signature <code class="docutils literal notranslate"><span class="pre">rename(name:</span> <span class="pre">str)</span> <span class="pre">-&gt;</span> <span class="pre">str</span></code>) to use to rename all
field names</p></li>
</ul>
<p>The renamed field names are used for encoding and decoding only, any python
code will still refer to them using their original names.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">msgspec</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">Example</span><span class="p">(</span><span class="n">msgspec</span><span class="o">.</span><span class="n">Struct</span><span class="p">,</span> <span class="n">rename</span><span class="o">=</span><span class="s2">&quot;camel&quot;</span><span class="p">):</span>
<span class="gp">... </span>    <span class="sd">&quot;&quot;&quot;A struct with fields renamed using camelCase&quot;&quot;&quot;</span>
<span class="gp">... </span>    <span class="n">field_one</span><span class="p">:</span> <span class="nb">int</span>
<span class="gp">... </span>    <span class="n">field_two</span><span class="p">:</span> <span class="nb">str</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Python code uses the original field names</span>
<span class="gp">... </span><span class="n">ex</span> <span class="o">=</span> <span class="n">Example</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">field_two</span><span class="o">=</span><span class="s2">&quot;two&quot;</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Encoded messages use the renamed field names</span>
<span class="gp">... </span><span class="n">msgspec</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
<span class="go">b&#39;{&quot;fieldOne&quot;:1,&quot;fieldTwo&quot;:&quot;two&quot;}&#39;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Decoding uses the renamed field names</span>
<span class="gp">... </span><span class="n">msgspec</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;{&quot;fieldOne&quot;: 3, &quot;fieldTwo&quot;: &quot;four&quot;}&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">Example</span><span class="p">)</span>
<span class="go">Example(field_one=3, field_two=&#39;four&#39;)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Decoding errors also use the renamed field names</span>
<span class="gp">... </span><span class="n">msgspec</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;{&quot;fieldOne&quot;: 5}&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">Example</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
  File <span class="nb">&quot;&lt;stdin&gt;&quot;</span>, line <span class="m">1</span>, in <span class="n">&lt;module&gt;</span>
<span class="gr">msgspec.DecodeError</span>: <span class="n">Object missing required field `fieldTwo`</span>
</pre></div>
</div>
<p>Note that if renaming to camelCase, you may run into issues if your field names
contain acronyms (e.g. <code class="docutils literal notranslate"><span class="pre">FQDN</span></code> in <code class="docutils literal notranslate"><span class="pre">setHostnameAsFQDN</span></code>). Some JSON style
guides prefer to fully-uppercase these components (<code class="docutils literal notranslate"><span class="pre">FQDN</span></code>), but <code class="docutils literal notranslate"><span class="pre">msgspec</span></code>
has no way to know if a component is an acroynm or not (and so will result in
<code class="docutils literal notranslate"><span class="pre">Fqdn</span></code>). As such, we recommend using an explicit dict mapping for renaming if
generating <code class="xref py py-obj docutils literal notranslate"><span class="pre">Struct</span></code> types to match an existing API.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#podspec-v1-core</span>
<span class="c1"># An explicit mapping from python name -&gt; JSON field name</span>
<span class="n">v1podspec_names</span> <span class="o">=</span> <span class="p">{</span>
    <span class="o">...</span>
    <span class="s2">&quot;service_account_name&quot;</span><span class="p">:</span> <span class="s2">&quot;serviceAccountName&quot;</span><span class="p">,</span>
    <span class="s2">&quot;set_hostname_as_fqdn&quot;</span><span class="p">:</span> <span class="s2">&quot;setHostnameAsFQDN&quot;</span><span class="p">,</span>
    <span class="o">...</span>
<span class="p">}</span>

<span class="c1"># Pass `.get` method to `rename` to explicitly rename all fields</span>
<span class="k">class</span> <span class="nc">V1PodSpec</span><span class="p">(</span><span class="n">msgspec</span><span class="o">.</span><span class="n">Struct</span><span class="p">,</span> <span class="n">rename</span><span class="o">=</span><span class="n">v1podspec_names</span><span class="o">.</span><span class="n">get</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">service_account_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">set_hostname_as_fqdn</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="o">...</span>
</pre></div>
</div>
</section>
<section id="encoding-decoding-as-arrays">
<h2>Encoding/Decoding as Arrays<a class="headerlink" href="#encoding-decoding-as-arrays" title="Permalink to this heading">#</a></h2>
<p>By default Struct objects encode the same dicts, with both the keys and values
present in the message.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">msgspec</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">Point</span><span class="p">(</span><span class="n">msgspec</span><span class="o">.</span><span class="n">Struct</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">x</span><span class="p">:</span> <span class="nb">int</span>
<span class="gp">... </span>    <span class="n">y</span><span class="p">:</span> <span class="nb">int</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">msgspec</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">Point</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="go">b&#39;{&quot;x&quot;:1,&quot;y&quot;:2}&#39;</span>
</pre></div>
</div>
<p>If you need higher performance (at the cost of more inscrutable message
encoding), you can set <code class="docutils literal notranslate"><span class="pre">array_like=True</span></code> on a struct definition. Structs with
this option enabled are encoded/decoded as array-like types, removing the field
names from the encoded message. This can provide on average another ~2x speedup
for decoding (and ~1.5x speedup for encoding).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">Point2</span><span class="p">(</span><span class="n">msgspec</span><span class="o">.</span><span class="n">Struct</span><span class="p">,</span> <span class="n">array_like</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">x</span><span class="p">:</span> <span class="nb">int</span>
<span class="gp">... </span>    <span class="n">y</span><span class="p">:</span> <span class="nb">int</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">msgspec</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">Point2</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="go">b&#39;[1,2]&#39;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">msgspec</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;[3,4]&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">Point2</span><span class="p">)</span>
<span class="go">Point2(x=3, y=4)</span>
</pre></div>
</div>
<p>Note that <a class="reference internal" href="#struct-tagged-unions"><span class="std std-ref">Tagged Unions</span></a> also work with structs with
<code class="docutils literal notranslate"><span class="pre">array_like=True</span></code>. In this case the tag is encoded as the first item in the
array, and is used to determine which type in the union to use when decoding.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">msgspec</span>

<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">Get</span><span class="p">(</span><span class="n">msgspec</span><span class="o">.</span><span class="n">Struct</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">array_like</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">key</span><span class="p">:</span> <span class="nb">str</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">Put</span><span class="p">(</span><span class="n">msgspec</span><span class="o">.</span><span class="n">Struct</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">array_like</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">key</span><span class="p">:</span> <span class="nb">str</span>
<span class="gp">... </span>    <span class="n">val</span><span class="p">:</span> <span class="nb">str</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">msgspec</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">Get</span><span class="p">(</span><span class="s2">&quot;my key&quot;</span><span class="p">))</span>
<span class="go">b&#39;[&quot;Get&quot;,&quot;my key&quot;]&#39;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">msgspec</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
<span class="gp">... </span>    <span class="sa">b</span><span class="s1">&#39;[&quot;Put&quot;, &quot;my key&quot;, &quot;my val&quot;]&#39;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="nb">type</span><span class="o">=</span><span class="n">Union</span><span class="p">[</span><span class="n">Get</span><span class="p">,</span> <span class="n">Put</span><span class="p">]</span>
<span class="gp">... </span><span class="p">)</span>
<span class="go">Put(key=&#39;my key&#39;, val=&#39;my val&#39;)</span>
</pre></div>
</div>
</section>
<section id="runtime-definition">
<h2>Runtime Definition<a class="headerlink" href="#runtime-definition" title="Permalink to this heading">#</a></h2>
<p>In some cases it can be useful to dynamically generate <a class="reference internal" href="api.html#msgspec.Struct" title="msgspec.Struct"><code class="xref py py-obj docutils literal notranslate"><span class="pre">msgspec.Struct</span></code></a> classes
at runtime. This can be handled through the use of <a class="reference internal" href="api.html#msgspec.defstruct" title="msgspec.defstruct"><code class="xref py py-obj docutils literal notranslate"><span class="pre">msgspec.defstruct</span></code></a>, which
has a signature similar to <a class="reference external" href="https://docs.python.org/3/library/dataclasses.html#dataclasses.make_dataclass" title="(in Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">dataclasses.make_dataclass</span></code></a>. See
<a class="reference internal" href="api.html#msgspec.defstruct" title="msgspec.defstruct"><code class="xref py py-obj docutils literal notranslate"><span class="pre">msgspec.defstruct</span></code></a> for more information.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">msgspec</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">Point</span> <span class="o">=</span> <span class="n">msgspec</span><span class="o">.</span><span class="n">defstruct</span><span class="p">(</span><span class="s2">&quot;Point&quot;</span><span class="p">,</span> <span class="p">[(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">)])</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span>
<span class="go">Point(x=1.0, y=2.0)</span>
</pre></div>
</div>
</section>
<section id="disabling-garbage-collection-advanced">
<span id="struct-gc"></span><h2>Disabling Garbage Collection (Advanced)<a class="headerlink" href="#disabling-garbage-collection-advanced" title="Permalink to this heading">#</a></h2>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This is an advanced optimization, and only recommended for users who fully
understand the implications of disabling the GC.</p>
</div>
<p>Python uses <a class="reference external" href="https://en.wikipedia.org/wiki/Reference_counting">reference counting</a> to detect when memory can be freed, with a
periodic <a class="reference external" href="https://devguide.python.org/garbage_collector/">cyclic garbage collector</a> pass to detect and free cyclic references.
Garbage collection (GC) is triggered by the number of uncollected GC-enabled
(objects that contain other objects) objects passing a certain threshold. This
design means that garbage collection passes often run during code that creates
a lot of objects (for example, deserializing a large message).</p>
<p>By default, <a class="reference internal" href="api.html#msgspec.Struct" title="msgspec.Struct"><code class="xref py py-obj docutils literal notranslate"><span class="pre">msgspec.Struct</span></code></a> types will only be tracked if they contain a
reference to a tracked object themselves. This means that structs referencing
only scalar values (ints, strings, bools, …) won’t contribute to GC load, but
structs referencing containers (lists, dicts, structs, …) will.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">msgspec</span>

<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>

<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">gc</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">Example</span><span class="p">(</span><span class="n">msgspec</span><span class="o">.</span><span class="n">Struct</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">x</span><span class="p">:</span> <span class="n">Any</span>
<span class="gp">... </span>    <span class="n">y</span><span class="p">:</span> <span class="n">Any</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">ex1</span> <span class="o">=</span> <span class="n">Example</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;two&quot;</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># ex1 is untracked, since it only references untracked objects</span>
<span class="gp">... </span><span class="n">gc</span><span class="o">.</span><span class="n">is_tracked</span><span class="p">(</span><span class="n">ex1</span><span class="p">)</span>
<span class="go">False</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">ex2</span> <span class="o">=</span> <span class="n">Example</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># ex2 is tracked, since it references tracked objects</span>
<span class="gp">... </span><span class="n">gc</span><span class="o">.</span><span class="n">is_tracked</span><span class="p">(</span><span class="n">ex2</span><span class="p">)</span>
<span class="go">True</span>
</pre></div>
</div>
<p>If you <em>are certain</em> that your struct types can <em>never</em> participate in a
reference cycle, you <em>may</em> find a <a class="reference internal" href="benchmarks.html#struct-gc-benchmark"><span class="std std-ref">performance boost</span></a> from setting <code class="docutils literal notranslate"><span class="pre">gc=False</span></code> on a struct definition. This
boost is tricky to measure in isolation, since it should only result in the
garbage collector not running as frequently - an integration benchmark is
recommended to determine if this is worthwhile for your workload. A workload is
likely to benefit from this optimization in the following situations:</p>
<ul class="simple">
<li><p>You’re allocating a lot of struct objects at once (for example, decoding a
large object). Setting <code class="docutils literal notranslate"><span class="pre">gc=False</span></code> on these types will reduce the
likelihood of a GC pass occurring while decoding, improving application
latency.</p></li>
<li><p>You have a large number of long-lived struct objects. Setting <code class="docutils literal notranslate"><span class="pre">gc=False</span></code>
on these types will reduce the load on the GC during collection cycles of
later generations.</p></li>
</ul>
<p>Struct types with <code class="docutils literal notranslate"><span class="pre">gc=False</span></code> will never be tracked, even if they reference
container types. It is your responsibility to ensure cycles with these objects
don’t occur, as a cycle containing only <code class="docutils literal notranslate"><span class="pre">gc=False</span></code> structs will <em>never</em> be
collected (leading to a memory leak).</p>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="extending.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Extending</div>
              </div>
              <svg><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="usage.html">
              <svg><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Usage</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2022, Jim Crist-Harif
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link " href="https://github.com/jcrist/msgspec" aria-label="GitHub"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path>
</svg></a>
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            Contents
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Structs</a><ul>
<li><a class="reference internal" href="#type-validation">Type Validation</a></li>
<li><a class="reference internal" href="#pattern-matching">Pattern Matching</a></li>
<li><a class="reference internal" href="#equality-and-order">Equality and Order</a></li>
<li><a class="reference internal" href="#frozen-instances">Frozen Instances</a></li>
<li><a class="reference internal" href="#tagged-unions">Tagged Unions</a></li>
<li><a class="reference internal" href="#omitting-default-values">Omitting Default Values</a></li>
<li><a class="reference internal" href="#renaming-field-names">Renaming Field Names</a></li>
<li><a class="reference internal" href="#encoding-decoding-as-arrays">Encoding/Decoding as Arrays</a></li>
<li><a class="reference internal" href="#runtime-definition">Runtime Definition</a></li>
<li><a class="reference internal" href="#disabling-garbage-collection-advanced">Disabling Garbage Collection (Advanced)</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/scripts/furo.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    </body>
</html>