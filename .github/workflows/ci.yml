name: Build and Test

on:
  push:
    branches:
      - main
  pull_request:
    branches:
    - main
    paths:
    - "msgspec/**"
    - ".github/workflows/ci.yml"
    - ".pre-commit-config.yaml"
    - "pyproject.toml"
    - "setup.py"
    - "setup.cfg"
  release:
    types:
    - published

env:
  # We want to test a real installation as a user.
  UV_NO_EDITABLE: "true"

jobs:
  lint:
    name: Run static analysis
    runs-on: ubuntu-latest

    env:
      # We manually select the required dependency groups rather than installing
      # everything with the default `dev` group and don't want to redundantly
      # supply the same flags to `uv run`.
      UV_NO_SYNC: "true"

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Install Python
      uses: actions/setup-python@v6
      with:
        python-version: "3.11"

    - name: Install uv
      uses: astral-sh/setup-uv@v7

    - name: Build msgspec and install dependencies
      run: uv sync

    - name: Run pre-commit hooks
      run: uv run -- pre-commit run --all-files --show-diff-on-failure

    - name: mypy
      run: uv run -- pytest tests/test_mypy.py

    - name: pyright
      run: uv run -- pytest tests/test_pyright.py

    - name: doctests
      run: uv run -- pytest --doctest-modules --pyargs msgspec

    - name: Rebuild with sanitizers & coverage
      env:
        MSGSPEC_SANITIZE: "true"
        MSGSPEC_COVERAGE: "true"
      run: |
        git clean -fdX
        uv sync --reinstall-package msgspec

    - name: Run tests with sanitizers
      env:
        PYTHONMALLOC: "malloc"
        ASAN_OPTIONS: "detect_leaks=0"
      run: >-
        LD_PRELOAD=`gcc -print-file-name=libasan.so` uv run --
        coverage run -m pytest -s -m "not mypy and not pyright"

    - name: Generate coverage files
      run: |
        uv run -- coverage xml
        gcov -abcu `find build/ -name *.o`

    - name: Upload coverage artifacts
      uses: actions/upload-artifact@v5
      with:
        name: coverage-files
        path: |-
          coverage.xml
          _core.c.gcov
          atof.h.gcov
          ryu.h.gcov
        if-no-files-found: error

  upload-coverage:
    name: Upload coverage files to Codecov
    needs:
    - lint
    runs-on: ubuntu-latest
    permissions:
      id-token: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Download coverage artifacts
      uses: actions/download-artifact@v5
      with:
        pattern: coverage-files
        merge-multiple: true
        path: coverage-files

    - name: Upload Codecov
      uses: codecov/codecov-action@v5
      with:
        use_oidc: true
        directory: coverage-files

  build-sdist:
    name: Build Source Distribution
    runs-on: ubuntu-latest

    outputs:
      artifact-name: "${{ steps.locate-artifact.outputs.file-name }}"

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Install Python
      uses: actions/setup-python@v6
      with:
        python-version: "3.13"

    - name: Install uv
      uses: astral-sh/setup-uv@v7

    - name: Build source distribution
      run: uv build --sdist

    - name: Locate source distribution
      id: locate-artifact
      run: |-
        sdist_name=$(basename dist/*)
        echo "file-name=${sdist_name}" >> $GITHUB_OUTPUT

    - name: Upload artifact
      uses: actions/upload-artifact@v5
      with:
        name: artifact-sdist
        path: dist/${{ steps.locate-artifact.outputs.file-name }}
        if-no-files-found: error

  build-wheels:
    name: Build wheels on ${{ matrix.os }} for ${{ matrix.archs }}
    needs:
    - build-sdist
    - lint
    runs-on: "${{ matrix.os }}"
    strategy:
      fail-fast: false
      matrix:
        include:
        - os: ubuntu-24.04-arm
          archs: aarch64
        - os: ubuntu-latest
          archs: x86_64
        - os: macos-latest
          archs: arm64
        - os: macos-15-intel
          archs: x86_64
        # - os: windows-11-arm
        #   archs: ARM64
        - os: windows-latest
          archs: AMD64

    env:
      CIBW_SKIP: "${{ github.event_name != 'release' && '*-musllinux_*' || '' }}"

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Download source distribution
      uses: actions/download-artifact@v6
      with:
        name: artifact-sdist
        path: dist

    # TODO: Remove this once the action supports specifying extras, see:
    # https://github.com/pypa/cibuildwheel/pull/2630
    - name: Install uv
      if: runner.os != 'Linux'
      uses: astral-sh/setup-uv@v7

    - name: Build & Test Wheels
      uses: pypa/cibuildwheel@v3.2.1
      with:
        package-dir: dist/${{ needs.build-sdist.outputs.artifact-name }}
      env:
        CIBW_ARCHS: "${{ matrix.archs }}"

    - name: Upload artifact
      uses: actions/upload-artifact@v5
      with:
        name: artifact-wheels-${{ matrix.os }}-${{ matrix.archs }}
        path: wheelhouse/*.whl
        if-no-files-found: error

  upload-pypi:
    name: Upload artifacts to PyPI
    if: github.event_name == 'release' && github.event.action == 'published'
    needs:
    - build-sdist
    - build-wheels
    runs-on: ubuntu-latest
    permissions:
      id-token: write

    steps:
    - uses: actions/download-artifact@v6
      with:
        pattern: artifact-*
        merge-multiple: true
        path: dist

    - name: Publish package distributions to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
